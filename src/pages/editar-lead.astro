---
import Layout from '../layouts/Layout.astro';
import { getAuthSheets, SPREADSHEET_ID } from '../lib/sheets';

const sheetName = Astro.url.searchParams.get('sheet');
const index = Astro.url.searchParams.get('index');

let data = [];
let success = false;
let error = null;

// Carregar Dados (L√™ at√© a coluna P agora)
if (sheetName && index !== null) {
    try {
        const sheets = await getAuthSheets();
        const realRow = parseInt(index) + 2; 
        // Ajuste no range para ler at√© a coluna P
        const res = await sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID, 
            range: `'${sheetName}'!A${realRow}:P${realRow}`
        });
        data = res.data.values ? res.data.values[0] : [];
    } catch (e) {
        error = "Erro ao carregar: " + e.message;
    }
}

// Salvar Dados
if (Astro.request.method === "POST") {
    try {
        const fd = await Astro.request.formData();
        
        let origemFinal = fd.get('origem');
        const tipoTrafego = fd.get('tipo_trafego');
        
        // Mant√©m a l√≥gica: Se for Pago e n√£o for LP, adiciona ADS
        if (tipoTrafego === 'PAGO' && !origemFinal.includes('LP') && !origemFinal.includes('ADS')) {
            origemFinal = `${origemFinal} ADS`;
        }

        const updated = [
            fd.get('nome'),           // A
            fd.get('data'),           // B
            fd.get('rd_check') ? "TRUE" : "FALSE", // C
            origemFinal,              // D
            fd.get('numero'),         // E
            fd.get('seguimento'),     // F
            fd.get('produto'),        // G
            fd.get('quantidade'),     // H
            fd.get('qualificado'),    // I
            fd.get('motivo'),         // J
            fd.get('delegado'),       // K
            fd.get('status_guru'),    // L
            fd.get('pipefy_check') ? "TRUE" : "FALSE", // M
            fd.get('venda'),          // N
            fd.get('valor'),          // O
            fd.get('data_venda')      // P (Novo Campo: Data da Venda)
        ];
        
        const targetSheet = fd.get('target_sheet');
        const sheets = await getAuthSheets();
        const rowIndex = parseInt(index) + 2;
        
        // Ajuste no range para gravar at√© a coluna P
        await sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `'${targetSheet}'!A${rowIndex}:P${rowIndex}`,
            valueInputOption: 'USER_ENTERED',
            requestBody: { values: [updated] },
        });
        
        success = true;
        data = updated;
    } catch (e) {
        error = "Erro ao salvar: " + e.message;
    }
}

const v = (i) => data[i] || '';
const isChecked = (i) => {
    const val = (data[i] || '').toUpperCase();
    return val === 'TRUE' || val === 'VERDADEIRO' || val === 'SIM';
};

// L√≥gica para detectar se j√° √© ADS no formul√°rio de edi√ß√£o
const rawOrigem = v(3);
const isAds = rawOrigem.includes('ADS') || rawOrigem.includes('LP');
const cleanOrigem = rawOrigem.replace(' ADS', '').trim();
const today = new Date().toISOString().split('T')[0]; // Data de hoje para preenchimento autom√°tico
---

<Layout title="Editar Lead">
    <div class="max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-8 border-b border-slate-200 pb-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-900 tracking-tight">Editar Lead</h1>
                <p class="text-sm text-slate-500">Editando registro em: <strong class="text-slate-800">{sheetName}</strong></p>
            </div>
            <a href="/editar" class="px-4 py-2 text-sm font-medium text-slate-600 bg-white border border-slate-300 rounded hover:bg-slate-50 transition">‚Üê Voltar</a>
        </div>

        {success && <div class="bg-emerald-50 border border-emerald-200 text-emerald-800 p-4 rounded mb-6 font-bold flex items-center gap-2">‚úÖ Dados atualizados!</div>}
        {error && <div class="bg-red-50 border border-red-200 text-red-800 p-4 rounded mb-6 font-bold">{error}</div>}

        <form method="POST" class="bg-white border border-slate-200 rounded shadow-sm overflow-hidden">
            <input type="hidden" name="target_sheet" value={sheetName}>

            <div class="p-6 bg-slate-50 border-b border-slate-200">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="md:col-span-3">
                        <label class="label-form">Nome do Cliente *</label>
                        <input name="nome" value={v(0)} required class="input-form font-bold text-slate-900">
                    </div>
                    <div class="md:col-span-1">
                        <label class="label-form">Data Entrada *</label>
                        <input type="date" name="data" value={v(1)} class="input-form">
                    </div>

                    <div class="md:col-span-2">
                        <label class="label-form">Canal de Origem</label>
                        <select name="origem" class="input-form font-bold text-slate-700">
                            {['INSTAGRAM','FORMS INSTAGRAM','SITE','WHATSAPP','LP META','LP GOOGLE','INDICA√á√ÉO','RD STATION','E-MAIL MKT','ORG√ÇNICO','OUTROS'].map(opt => (
                                <option selected={cleanOrigem === opt} value={opt}>{opt}</option>
                            ))}
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="label-form text-blue-600">Tipo de Tr√°fego</label>
                        <div class="flex gap-4 mt-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="tipo_trafego" value="ORGANICO" checked={!isAds} class="w-4 h-4 text-slate-900 focus:ring-slate-500">
                                <span class="text-sm font-medium text-slate-700">Org√¢nico</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="tipo_trafego" value="PAGO" checked={isAds} class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm font-bold text-blue-700 bg-blue-50 px-2 py-0.5 rounded border border-blue-100">Tr√°fego Pago (Ads)</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-b border-slate-200">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="label-form">Telefone</label>
                        <input name="numero" value={v(4)} class="input-form">
                    </div>
                    
                    <div>
                        <label class="label-form">Segmento</label>
                        <input name="seguimento" value={v(5)} list="list-seg" class="input-form">
                        <datalist id="list-seg">
                            <option value="Pote"></option>
                            <option value="Copo"></option>
                            <option value="Pizza"></option>
                            <option value="Cx Sorvete"></option>
                            <option value="Projeto Especial"></option>
                        </datalist>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="label-form">Produto</label>
                        <input name="produto" value={v(6)} list="list-prod" class="input-form">
                        <datalist id="list-prod">
                            <option value="Projeto Especial"/>
                            <option value="Copo 100ml"/><option value="Copo 200ml"/><option value="Copo 400ml"/><option value="Copo 500ml"/>
                            <option value="Pote 100ml"/><option value="Pote 120ml"/><option value="Pote 150ml"/><option value="Pote 180ml"/>
                            <option value="Pote 240ml"/><option value="Pote 360ml"/><option value="Pote 480ml"/><option value="Pote 500ml"/><option value="Pote 1000ml"/>
                            <option value="Pizza Oitavada"/><option value="Pizza Quadrada"/><option value="Pizza Sextavada"/>
                            <option value="Caixa de Sorvete 5L"/><option value="Caixa de Sorvete 7L"/><option value="Caixa de Sorvete 10L"/>
                        </datalist>
                    </div>

                    <div>
                        <label class="label-form">Qtd. Estimada</label>
                        <select name="quantidade" class="input-form">
                            <option value="">Selecione...</option>
                            {['M√≠nimo','5 mil','10 mil','15 mil','30 mil','50 mil'].map(opt => (
                                <option selected={v(7) === opt} value={opt}>{opt}</option>
                            ))}
                        </select>
                    </div>
                </div>
            </div>

            <div class="p-6 border-b border-slate-200 bg-slate-50/50">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div>
                        <label class="label-form">Qualificado?</label>
                        <select name="qualificado" class="input-form">
                            <option selected={v(8) === 'SIM'}>SIM</option>
                            <option selected={v(8) === 'N√ÉO'}>N√ÉO</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-form">Delegado Para</label>
                        <select name="delegado" class="input-form">
                            <option value="">-- Selecione --</option>
                            {['Clodoaldo','Michele','Angela','Joelma','Diretoria'].map(opt => (
                                <option selected={v(10) === opt} value={opt}>{opt}</option>
                            ))}
                        </select>
                    </div>
                    <div>
                        <label class="label-form">Status no Guru</label>
                        <select name="status_guru" class="input-form">
                            {['PRIMEIRO CONTATO','EM NEGOCIA√á√ÉO','AGUARDANDO RETORNO','PERDIDO','VENDA FECHADA'].map(opt => (
                                <option selected={v(11) === opt} value={opt}>{opt}</option>
                            ))}
                        </select>
                    </div>
                    <div>
                        <label class="label-form">Motivo (se N√£o)</label>
                        <input name="motivo" value={v(9)} class="input-form">
                    </div>
                </div>
            </div>

            <div class="p-6 bg-slate-100">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-center">
                    
                    <div class="md:col-span-3 flex flex-col gap-3">
                        <label class="flex items-center gap-3 p-3 bg-white border border-slate-200 rounded cursor-pointer hover:border-slate-400 transition">
                            <input type="checkbox" name="rd_check" checked={isChecked(2)} class="w-4 h-4 text-slate-800 rounded focus:ring-slate-500">
                            <span class="text-sm font-medium text-slate-700">Lead no RD Station</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 bg-white border border-slate-200 rounded cursor-pointer hover:border-slate-400 transition">
                            <input type="checkbox" name="pipefy_check" checked={isChecked(12)} class="w-4 h-4 text-slate-800 rounded focus:ring-slate-500">
                            <span class="text-sm font-medium text-slate-700">Add no Pipefy</span>
                        </label>
                    </div>

                    <div class="md:col-span-9 grid grid-cols-3 gap-6 pl-0 md:pl-6 border-l border-slate-200">
                        <div>
                            <label class="label-form text-slate-700">Venda Fechada?</label>
                            <select name="venda" id="select_venda" class="input-form font-medium" onchange="toggleDate()">
                                <option value="">Em aberto</option>
                                <option selected={v(13) === 'Sim'} value="Sim">Sim (Venda Realizada)</option>
                                <option selected={v(13) === 'N√£o'} value="N√£o">N√£o (Perdido)</option>
                            </select>
                        </div>
                        <div>
                            <label class="label-form text-slate-700">Valor do Pedido (R$)</label>
                            <input name="valor" value={v(14)} class="input-form font-mono text-right font-bold text-slate-800">
                        </div>
                        <div id="div_data_venda" class={v(13) === 'Sim' ? '' : 'opacity-50 pointer-events-none'}>
                            <label class="label-form text-emerald-700">Data do Fechamento</label>
                            <input type="date" name="data_venda" id="input_data_venda" value={v(15)} class="input-form border-emerald-300 bg-emerald-50">
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 bg-white border-t border-slate-200 flex justify-end">
                <button type="submit" class="bg-slate-900 text-white px-8 py-3 rounded font-bold text-sm hover:bg-slate-800 transition shadow-sm flex items-center gap-2">
                    <span>üíæ</span> SALVAR ALTERA√á√ïES
                </button>
            </div>
        </form>
    </div>

    <script define:vars={{today}}>
        function toggleDate() {
            const select = document.getElementById('select_venda');
            const div = document.getElementById('div_data_venda');
            const input = document.getElementById('input_data_venda');

            if (select.value === 'Sim') {
                div.classList.remove('opacity-50', 'pointer-events-none');
                // Se estiver vazio, preenche com hoje
                if (!input.value) input.value = today;
            } else {
                div.classList.add('opacity-50', 'pointer-events-none');
                // Opcional: Limpar se mudar para "N√£o" ou "Em aberto". 
                // Comentei para evitar apagar dados acidentalmente se o usu√°rio s√≥ clicar errado.
                // input.value = ''; 
            }
        }
        // Roda ao carregar para definir o estado inicial correto
        window.addEventListener('DOMContentLoaded', toggleDate);
    </script>

    <style>
        .label-form { @apply block text-xs font-bold text-slate-500 uppercase mb-1.5 tracking-wide; }
        .input-form { @apply w-full border border-slate-300 rounded px-3 py-2 text-sm text-slate-700 focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition bg-white; }
    </style>
</Layout>
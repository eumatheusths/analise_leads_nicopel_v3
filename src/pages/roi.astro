---
import Layout from '../layouts/Layout.astro';
import { getAuthSheets, SPREADSHEET_ID, MONTHS, getCurrentMonthSheetName } from '../lib/sheets';

const urlMonth = Astro.url.searchParams.get('month');
const selectedMonth = urlMonth || getCurrentMonthSheetName();

let roiData = [];
let errorMsg = null;
let successMsg = null;

// Mapa de √≠cones e cores para deixar bonito
const metricConfig = {
    "Investimento": { icon: "üí∏", color: "text-red-600", bg: "bg-red-50" },
    "Faturamento Total": { icon: "üí∞", color: "text-green-600", bg: "bg-green-50", bold: true },
    "ROAS": { icon: "üöÄ", color: "text-blue-600", bg: "bg-blue-50", bold: true },
    "Vendas": { icon: "ü§ù", color: "text-emerald-600", bg: "bg-emerald-50" },
    "Leads": { icon: "üë•", color: "text-gray-600", bg: "bg-gray-50" },
    "default": { icon: "üìä", color: "text-slate-600", bg: "bg-white" }
};

// --- L√ìGICA DE SALVAR (POST) ---
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const sheets = await getAuthSheets();
        
        // 1. Descobrir a letra da coluna do m√™s (Jan=B, Fev=C...)
        // O array MONTHS come√ßa em 0 (Janeiro). Na planilha:
        // A=Metricas, B=Janeiro(idx 0), C=Fevereiro(idx 1)...
        // Ent√£o indice do m√™s + 2 = Indice da coluna na API (1-based? nao, A1 notation)
        // Vamos simplificar: Pegar tudo, achar o indice do array e atualizar a coluna correspondente.
        
        const monthIndex = MONTHS.indexOf(selectedMonth);
        if (monthIndex === -1) throw new Error("M√™s inv√°lido");

        // Construir o array de valores para salvar (vertical)
        // Precisamos garantir que a ordem dos inputs bata com a ordem das linhas na planilha
        // Vamos ler a coluna A primeiro para garantir a ordem
        const meta = await sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: `'ROI'!A2:A20`
        });
        
        const metricNames = meta.data.values ? meta.data.values.map(r => r[0]) : [];
        
        // Monta a coluna de valores novos
        const newValues = metricNames.map(name => {
            const val = formData.get(name) || "0";
            return [val]; // A API pede array de arrays para colunas [[val1], [val2]]
        });

        // Calcula a letra da coluna. B=Janeiro.
        // B √© charCode 66.
        const colLetter = String.fromCharCode(66 + monthIndex); // 66 + 0 = B, 66+1 = C...
        
        // Atualiza a coluna do m√™s
        await sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `'ROI'!${colLetter}2:${colLetter}${1 + newValues.length}`,
            valueInputOption: 'USER_ENTERED',
            requestBody: { values: newValues }
        });

        successMsg = "Dados atualizados com sucesso!";

    } catch (e) {
        errorMsg = "Erro ao salvar: " + e.message;
    }
}

// --- L√ìGICA DE LEITURA (GET) ---
try {
    const sheets = await getAuthSheets();
    
    // 1. Pega Nomes das M√©tricas (A) e Valores do M√™s Selecionado
    const monthIndex = MONTHS.indexOf(selectedMonth);
    const colLetter = String.fromCharCode(66 + monthIndex); // B, C, D...

    // Busca coluna A (Nomes) e Coluna do M√™s
    // BatchGet para ser r√°pido
    const response = await sheets.spreadsheets.values.batchGet({
        spreadsheetId: SPREADSHEET_ID,
        ranges: [`'ROI'!A2:A20`, `'ROI'!${colLetter}2:${colLetter}20`]
    });

    const labels = response.data.valueRanges[0].values || [];
    const values = response.data.valueRanges[1].values || [];

    // Mescla os dois arrays
    roiData = labels.map((labelRow, i) => {
        const label = labelRow[0];
        const val = values[i] ? values[i][0] : "-";
        
        // Configura√ß√£o visual
        const config = metricConfig[label] || metricConfig["default"];
        
        return {
            label: label,
            value: val,
            ...config
        };
    });

} catch (e) {
    errorMsg = "Certifique-se de criar a aba 'ROI' na planilha com as m√©tricas na Coluna A.";
}
---

<Layout title="ROI Financeiro">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <div>
            <h2 class="text-3xl font-bold text-gray-800">Performance Financeira</h2>
            <p class="text-sm text-gray-500">Dados consolidados de: <span class="font-bold text-blue-600 uppercase">{selectedMonth}</span></p>
        </div>
        
        <div class="flex gap-2 w-full md:w-auto">
            <form method="GET" class="bg-white p-2 rounded-lg border shadow-sm flex items-center gap-2 w-full">
                <span class="text-xs font-bold text-gray-500 uppercase px-2">M√™s:</span>
                <select name="month" onchange="this.form.submit()" class="bg-gray-100 border-transparent rounded text-sm font-bold text-gray-700 focus:ring-0 py-2 px-3 cursor-pointer w-full outline-none">
                    {MONTHS.map(m => (
                        <option value={m} selected={m === selectedMonth}>{m}</option>
                    ))}
                </select>
            </form>
            
            <button onclick="document.getElementById('editModal').showModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow-sm transition whitespace-nowrap">
                ‚úèÔ∏è Editar Dados
            </button>
        </div>
    </div>

    {successMsg && <div class="bg-green-100 text-green-700 p-4 rounded mb-6 font-bold text-center animate-bounce">{successMsg}</div>}
    {errorMsg && <div class="bg-red-100 text-red-700 p-4 rounded mb-6 font-bold text-center">{errorMsg}</div>}

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-12">
        {roiData.map((item) => (
            <div class={`p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col justify-between hover:shadow-md transition bg-white relative overflow-hidden group`}>
                <div class={`absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition text-4xl`}>{item.icon}</div>
                
                <div>
                    <p class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">{item.label}</p>
                    <h3 class={`text-2xl ${item.bold ? 'font-black' : 'font-bold'} ${item.color}`}>
                        {item.value}
                    </h3>
                </div>
                
                {/* Barrinha decorativa embaixo */}
                <div class={`h-1 w-full mt-4 rounded-full ${item.bg.replace('bg-', 'bg-opacity-50 ')} bg-gray-200`}>
                    <div class={`h-1 rounded-full ${item.color.replace('text-', 'bg-')} w-1/2`}></div>
                </div>
            </div>
        ))}
    </div>

    <dialog id="editModal" class="modal rounded-xl shadow-2xl p-0 w-full max-w-2xl backdrop:bg-gray-900/50">
        <div class="bg-white">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-xl font-bold text-gray-800">Editar Dados de {selectedMonth}</h3>
                <button onclick="document.getElementById('editModal').close()" class="text-gray-400 hover:text-gray-600 font-bold text-xl">&times;</button>
            </div>
            
            <form method="POST" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-2">
                    {roiData.map((item) => (
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">{item.label}</label>
                            <input 
                                type="text" 
                                name={item.label} 
                                value={item.value === '-' ? '' : item.value} 
                                class="w-full border border-gray-300 rounded p-2 focus:ring-2 focus:ring-blue-500 outline-none font-medium text-gray-700"
                                placeholder="Digite o valor..."
                            >
                        </div>
                    ))}
                </div>
                
                <div class="mt-6 pt-4 border-t border-gray-100 flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('editModal').close()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-bold transition">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold shadow-lg transition transform active:scale-95">Salvar Altera√ß√µes</button>
                </div>
            </form>
        </div>
    </dialog>

</Layout>
---
import Layout from '../layouts/Layout.astro';
import { getAuthSheets, SPREADSHEET_ID, MONTHS, getCurrentMonthSheetName } from '../lib/sheets';

const urlMonth = Astro.url.searchParams.get('month');
const selectedMonth = urlMonth || getCurrentMonthSheetName();

let roiData = [];
let errorMsg = null;
let successMsg = null;

// Configura√ß√£o Visual (√çcones e Cores para cada m√©trica espec√≠fica)
const metricConfig = {
    "Investimento": { icon: "üí∏", color: "text-red-600", bg: "bg-red-50" },
    "Leads": { icon: "üë•", color: "text-gray-600", bg: "bg-gray-50" },
    "Custo por Leads": { icon: "üìâ", color: "text-orange-600", bg: "bg-orange-50" },
    "% de MQL": { icon: "üéØ", color: "text-purple-600", bg: "bg-purple-50" },
    "MQL": { icon: "‚≠ê", color: "text-indigo-600", bg: "bg-indigo-50" },
    "Custo por MQL": { icon: "üí≤", color: "text-orange-600", bg: "bg-orange-50" },
    "Convers√£o de Lead para Venda": { icon: "üîÑ", color: "text-blue-500", bg: "bg-blue-50" },
    "Convers√£o de MQL para Venda": { icon: "‚ö°", color: "text-blue-700", bg: "bg-blue-50" },
    "Vendas": { icon: "ü§ù", color: "text-emerald-600", bg: "bg-emerald-50" },
    "Custo por Venda": { icon: "üè∑Ô∏è", color: "text-red-500", bg: "bg-red-50" },
    "Ticket M√©dio": { icon: "üí≥", color: "text-cyan-600", bg: "bg-cyan-50" },
    
    // Destaques Principais
    "Faturamento Total": { icon: "üí∞", color: "text-green-700", bg: "bg-green-100", bold: true, border: "border-green-300" },
    "ROAS (Total)": { icon: "üöÄ", color: "text-blue-700", bg: "bg-blue-100", bold: true, border: "border-blue-300" },
    
    // LT Metrics
    "COM LT DE + 3 COMPRAS (66%)": { icon: "üì¶", color: "text-purple-700", bg: "bg-purple-100", bold: true },
    "ROAS LT 3": { icon: "üìà", color: "text-pink-600", bg: "bg-pink-50", bold: true },
    
    "default": { icon: "bar_chart", color: "text-slate-600", bg: "bg-white" }
};

// --- SALVAR DADOS (POST) ---
if (Astro.request.method === "POST") {
    try {
        const formData = await Astro.request.formData();
        const sheets = await getAuthSheets();
        
        const monthIndex = MONTHS.indexOf(selectedMonth);
        if (monthIndex === -1) throw new Error("M√™s inv√°lido");

        // L√™ a coluna A para garantir a ordem de salvamento
        const meta = await sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: `'ROI'!A2:A30` // L√™ at√© a linha 30 para garantir
        });
        
        const metricNames = meta.data.values ? meta.data.values.map(r => r[0]) : [];
        
        // Mapeia os valores enviados pelo formul√°rio na ordem da planilha
        const newValues = metricNames.map(name => {
            if (!name) return [""]; // Se a linha A estiver vazia, salva vazio
            const val = formData.get(name) || ""; // Se n√£o mandou nada, salva vazio (n√£o zero, pra n√£o sujar)
            return [val]; 
        });

        const colLetter = String.fromCharCode(66 + monthIndex); // B, C, D...
        
        await sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `'ROI'!${colLetter}2:${colLetter}${1 + newValues.length}`,
            valueInputOption: 'USER_ENTERED',
            requestBody: { values: newValues }
        });

        successMsg = "Dados atualizados com sucesso!";
    } catch (e) {
        errorMsg = "Erro ao salvar: " + e.message;
    }
}

// --- LER DADOS (GET) ---
try {
    const sheets = await getAuthSheets();
    const monthIndex = MONTHS.indexOf(selectedMonth);
    const colLetter = String.fromCharCode(66 + monthIndex);

    const response = await sheets.spreadsheets.values.batchGet({
        spreadsheetId: SPREADSHEET_ID,
        ranges: [`'ROI'!A2:A30`, `'ROI'!${colLetter}2:${colLetter}30`]
    });

    const labels = response.data.valueRanges[0].values || [];
    const values = response.data.valueRanges[1].values || [];

    roiData = labels.map((labelRow, i) => {
        const label = labelRow[0];
        // Se n√£o tiver label (linha vazia na planilha), retorna null para filtrar depois
        if (!label || label.trim() === "") return null;

        const val = values[i] ? values[i][0] : "-";
        const config = metricConfig[label] || metricConfig["default"];
        
        return { label: label, value: val, ...config };
    }).filter(item => item !== null); // Remove as linhas vazias da visualiza√ß√£o

} catch (e) {
    errorMsg = "Certifique-se de criar a aba 'ROI' na planilha.";
}
---

<Layout title="ROI Financeiro">
    <script is:inline src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center mb-8 gap-4">
        <div>
            <h2 class="text-3xl font-bold text-gray-800">Performance Financeira</h2>
            <p class="text-sm text-gray-500">M√™s de Refer√™ncia: <span class="font-bold text-blue-600 uppercase">{selectedMonth}</span></p>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-2 w-full xl:w-auto">
            <form method="GET" class="bg-white p-2 rounded-lg border shadow-sm flex items-center gap-2 flex-1 sm:flex-none">
                <span class="text-xs font-bold text-gray-500 uppercase px-2">M√™s:</span>
                <select name="month" onchange="this.form.submit()" class="bg-gray-100 border-transparent rounded text-sm font-bold text-gray-700 focus:ring-0 py-2 px-3 cursor-pointer w-full outline-none">
                    {MONTHS.map(m => (
                        <option value={m} selected={m === selectedMonth}>{m}</option>
                    ))}
                </select>
            </form>
            
            <div class="flex gap-2">
                <button onclick="downloadTemplate()" class="bg-green-100 hover:bg-green-200 text-green-700 px-4 py-2 rounded-lg font-bold shadow-sm transition text-sm flex items-center gap-2 whitespace-nowrap">
                    üì• Modelo
                </button>
                
                <label class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 px-4 py-2 rounded-lg font-bold shadow-sm transition text-sm flex items-center gap-2 whitespace-nowrap cursor-pointer">
                    üì§ Importar
                    <input type="file" id="importFile" accept=".xlsx, .csv" class="hidden" onchange="handleImport(this)">
                </label>

                <button onclick="document.getElementById('editModal').showModal()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-bold shadow-sm transition whitespace-nowrap text-sm flex items-center gap-2">
                    ‚úèÔ∏è Editar
                </button>
            </div>
        </div>
    </div>

    {successMsg && <div class="bg-green-100 text-green-700 p-4 rounded mb-6 font-bold text-center border border-green-200">{successMsg}</div>}
    {errorMsg && <div class="bg-red-100 text-red-700 p-4 rounded mb-6 font-bold text-center border border-red-200">{errorMsg}</div>}

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mb-12">
        {roiData.map((item) => (
            <div class={`p-6 rounded-xl shadow-sm border ${item.border ? item.border : 'border-gray-100'} flex flex-col justify-between hover:shadow-md transition bg-white relative overflow-hidden group`}>
                <div class={`absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition text-4xl grayscale hover:grayscale-0`}>
                    {item.icon}
                </div>
                
                <div>
                    <p class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-2">{item.label}</p>
                    <h3 class={`text-2xl ${item.bold ? 'font-black' : 'font-bold'} ${item.color} truncate`}>
                        {item.value}
                    </h3>
                </div>
                
                <div class={`h-1.5 w-full mt-4 rounded-full ${item.bg} bg-opacity-50`}>
                    <div class={`h-1.5 rounded-full ${item.color.replace('text-', 'bg-')} w-1/2 opacity-70`}></div>
                </div>
            </div>
        ))}
    </div>

    <dialog id="editModal" class="modal rounded-xl shadow-2xl p-0 w-full max-w-2xl backdrop:bg-gray-900/50">
        <div class="bg-white">
            <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-slate-50">
                <h3 class="text-xl font-bold text-gray-800">Editar M√©tricas - {selectedMonth}</h3>
                <button onclick="document.getElementById('editModal').close()" class="text-gray-400 hover:text-gray-600 font-bold text-xl">&times;</button>
            </div>
            
            <form method="POST" class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-[60vh] overflow-y-auto pr-2 custom-scrollbar">
                    {roiData.map((item) => (
                        <div class="relative">
                            <label class="block text-[10px] font-bold text-gray-500 uppercase mb-1">{item.label}</label>
                            <div class="relative">
                                <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400 pointer-events-none">
                                    {item.label.includes('%') || item.label.includes('Convers√£o') ? '%' : (item.label.includes('ROAS') ? 'x' : 'R$')}
                                </span>
                                <input 
                                    type="text" 
                                    name={item.label} 
                                    id={`input_${item.label.replace(/\s+/g, '_')}`}
                                    value={item.value === '-' ? '' : item.value} 
                                    class="w-full border border-gray-300 rounded-lg p-2.5 pl-8 focus:ring-2 focus:ring-blue-500 outline-none font-medium text-gray-700 text-sm"
                                    placeholder="0,00"
                                >
                            </div>
                        </div>
                    ))}
                </div>
                
                <div class="mt-6 pt-4 border-t border-gray-100 flex justify-end gap-3">
                    <button type="button" onclick="document.getElementById('editModal').close()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-bold transition text-sm">Cancelar</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold shadow-lg transition transform active:scale-95 text-sm">Salvar Dados</button>
                </div>
            </form>
        </div>
    </dialog>

    <script>
        // Lista EXATA de m√©tricas para o Modelo de Importa√ß√£o
        const TEMPLATE_METRICS = [
            "Investimento",
            "Leads",
            "Custo por Leads",
            "% de MQL",
            "MQL",
            "Custo por MQL",
            "Convers√£o de Lead para Venda",
            "Convers√£o de MQL para Venda",
            "Vendas",
            "Custo por Venda",
            "Ticket M√©dio",
            "Faturamento Total",
            "ROAS (Total)",
            "COM LT DE + 3 COMPRAS (66%)",
            "ROAS LT 3"
        ];

        // 1. BAIXAR MODELO ATUALIZADO
        function downloadTemplate() {
            // Cria os dados: Cabe√ßalho + Lista Fixa de M√©tricas
            const ws_data = [
                ["M√©trica", "Valor"], // Cabe√ßalho
                ...TEMPLATE_METRICS.map(label => [label, ""]) // Linhas
            ];
            
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Modelo_ROI");
            
            XLSX.writeFile(wb, "Modelo_Nicopel_ROI.xlsx");
        }

        // 2. IMPORTAR EXCEL E PREENCHER O FORM
        function handleImport(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

                document.getElementById('editModal').showModal();

                jsonData.forEach(row => {
                    if (row.length >= 2) {
                        const label = row[0]; 
                        const val = row[1];
                        
                        if (label && val !== undefined) {
                            // Limpeza de string para achar o ID correto
                            const safeLabel = label.toString().trim().replace(/\s+/g, '_');
                            const inputId = `input_${safeLabel}`;
                            const inputElement = document.getElementById(inputId);
                            
                            if (inputElement) {
                                inputElement.value = val;
                                inputElement.parentElement.parentElement.classList.add('ring-2', 'ring-green-400', 'rounded-lg');
                                setTimeout(() => inputElement.parentElement.parentElement.classList.remove('ring-2', 'ring-green-400', 'rounded-lg'), 2000);
                            }
                        }
                    }
                });
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }

        window.downloadTemplate = downloadTemplate;
        window.handleImport = handleImport;
    </script>
</Layout>

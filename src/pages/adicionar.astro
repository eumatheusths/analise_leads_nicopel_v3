---
import Layout from '../layouts/Layout.astro';
import { getAuthSheets, SPREADSHEET_ID, getCurrentMonthSheetName, MONTHS, findRealSheetName } from '../lib/sheets';

let success = false;
let error = null;
let warning = null; 
const defaultMonth = getCurrentMonthSheetName();

if (Astro.request.method === "POST") {
    try {
        const data = await Astro.request.formData();
        const sheets = await getAuthSheets();
        
        const targetMonth = data.get('target_month') || defaultMonth;
        const realSheetName = await findRealSheetName(sheets, targetMonth);
        
        if (!realSheetName) throw new Error(`A aba "${targetMonth}" n√£o existe na planilha.`);

        const nomeInput = data.get('nome_cliente') || '';
        const telefoneInput = data.get('numero') || '';

        // =====================================================================
        // 1. TRATAMENTO INTELIGENTE DE TELEFONE (WPP SAFE E SHEETS SAFE)
        // =====================================================================
        let telefoneFormatado = telefoneInput;
        let telefoneInvalido = false;
        
        // Remove absolutamente tudo que n√£o for n√∫mero (+, -, espa√ßos, etc)
        let digitosTelefone = telefoneInput.replace(/\D/g, '');
        
        // Se come√ßar com 55 e tiver 12 ou mais d√≠gitos, remove o 55 (DDI do Brasil)
        if (digitosTelefone.startsWith('55') && digitosTelefone.length >= 12) {
            digitosTelefone = digitosTelefone.substring(2);
        }

        // Se o n√∫mero tem 10 d√≠gitos e come√ßa com 6, 7, 8 ou 9 (√© um celular sem o '9' extra)
        // N√≥s injetamos o '9' automaticamente!
        if (digitosTelefone.length === 10 && ['6','7','8','9'].includes(digitosTelefone[2])) {
            digitosTelefone = digitosTelefone.substring(0, 2) + '9' + digitosTelefone.substring(2);
        }

        // Agora formatamos para o padr√£o internacional lindinho
        // O ap√≥strofo (') na frente impede o Google Sheets de achar que √© uma f√≥rmula!
        if (digitosTelefone.length === 11) {
            telefoneFormatado = `'+55 (${digitosTelefone.substring(0, 2)}) ${digitosTelefone.substring(2, 7)}-${digitosTelefone.substring(7)}`;
        } else if (digitosTelefone.length === 10) {
            telefoneFormatado = `'+55 (${digitosTelefone.substring(0, 2)}) ${digitosTelefone.substring(2, 6)}-${digitosTelefone.substring(6)}`;
        } else if (digitosTelefone.length > 0) {
            telefoneInvalido = true;
            telefoneFormatado = `'+55 ${digitosTelefone}`; 
            warning = "O lead foi salvo, mas o n√∫mero de telefone ficou com um tamanho invulgar. Confere depois!";
        }

        // =====================================================================
        // 2. VERIFICA√á√ÉO DE DUPLICIDADE (ANTI-CLONE)
        // =====================================================================
        const nomeLimpo = nomeInput.trim().toLowerCase();
        
        const checkRes = await sheets.spreadsheets.values.get({
            spreadsheetId: SPREADSHEET_ID,
            range: `'${realSheetName}'!A2:E1000`,
        });
        
        const existingRows = checkRes.data.values || [];

        const isDuplicate = existingRows.some(row => {
            const rowNome = (row[0] || '').trim().toLowerCase();
            let rowTelefone = (row[4] || '').replace(/\D/g, ''); 
            
            if (rowTelefone.startsWith('55') && rowTelefone.length >= 12) {
                rowTelefone = rowTelefone.substring(2);
            }

            const mesmoTelefone = digitosTelefone !== '' && rowTelefone === digitosTelefone;
            const mesmoNome = nomeLimpo !== '' && rowNome === nomeLimpo;

            return mesmoTelefone || mesmoNome;
        });

        if (isDuplicate) {
            throw new Error("DUPLICIDADE: J√° existe um lead com este Nome ou Telefone cadastrado neste m√™s!");
        }

        // =====================================================================
        // 3. PREPARA√á√ÉO E ENVIO DE DADOS
        // =====================================================================
        let origemFinal = data.get('origem');
        const tipoTrafego = data.get('tipo_trafego');
        
        if (tipoTrafego === 'PAGO' && !origemFinal.includes('LP')) {
            origemFinal = `${origemFinal} ADS`;
        }

        const formatDateForSheet = (dateStr) => {
            if (!dateStr) return '';
            if (dateStr.includes('-')) {
                const parts = dateStr.split('-');
                if (parts[0].length === 4) {
                    return `${parts[2]}/${parts[1]}/${parts[0]}`; 
                }
            }
            return dateStr;
        };

        const statusVenda = data.get('venda') || '';
        let dataVendaFinal = data.get('data_venda') || '';
        
        if (statusVenda !== 'Sim') {
            dataVendaFinal = ''; 
        }

        const row = [
            data.get('nome_cliente') || '',       
            formatDateForSheet(data.get('data')), 
            data.get('rd_check') ? "TRUE" : "FALSE", 
            origemFinal || '',                    
            telefoneFormatado, // Agora vai com a plica (') para n√£o quebrar o Sheets
            data.get('seguimento') || '',         
            data.get('produto') || '',            
            data.get('quantidade') || '',         
            data.get('qualificado') || '',        
            data.get('motivo') || '',             
            data.get('delegado') || '',           
            data.get('status_guru') || '',        
            data.get('pipefy_check') ? "TRUE" : "FALSE", 
            statusVenda,                          
            data.get('valor') || '',              
            formatDateForSheet(dataVendaFinal)    
        ];

        await sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: `'${realSheetName}'!A:P`,
            valueInputOption: 'USER_ENTERED',
            requestBody: { values: [row] },
        });

        success = true;
    } catch (e) {
        error = e.message; 
    }
}

const today = new Date().toISOString().split('T')[0];
---

<Layout title="Novo Lead">
    <div class="max-w-5xl mx-auto">
        <div class="flex justify-between items-center mb-8 border-b border-slate-200 pb-4">
            <div>
                <h1 class="text-2xl font-bold text-slate-900 tracking-tight">Cadastro de Lead</h1>
                <p class="text-sm text-slate-500">Novo formul√°rio padronizado.</p>
            </div>
            <a href="/" class="px-4 py-2 text-sm font-medium text-slate-600 bg-white border border-slate-300 rounded hover:bg-slate-50 transition">Cancelar</a>
        </div>

        {success && !warning && <div class="bg-emerald-50 border border-emerald-200 text-emerald-800 p-4 rounded mb-6 font-bold flex items-center gap-2">‚úÖ Sucesso! <a href="/" class="underline">Ir para o Dashboard</a></div>}
        
        {success && warning && (
            <div class="bg-yellow-50 border border-yellow-300 text-yellow-800 p-4 rounded mb-6 font-bold flex flex-col sm:flex-row items-center gap-3 shadow-sm">
                <span class="text-2xl">‚ö†Ô∏è</span> 
                <span>{warning} <a href="/" class="underline text-yellow-900 ml-2">Ir para o Dashboard</a></span>
            </div>
        )}

        {error && (
            <div class="bg-red-50 border border-red-200 text-red-800 p-4 rounded mb-6 font-bold flex items-center gap-3 shadow-sm">
                <span class="text-xl">üö®</span> 
                <span>{error}</span>
            </div>
        )}

        <form method="POST" class="bg-white border border-slate-200 rounded shadow-sm overflow-hidden">
            
            <div class="p-6 bg-slate-50 border-b border-slate-200">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div class="md:col-span-1">
                        <label class="label-form">M√™s</label>
                        <select name="target_month" class="input-form">
                            {MONTHS.map(m => <option value={m} selected={m === defaultMonth}>{m}</option>)}
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="label-form">Nome do Cliente *</label>
                        <input name="nome_cliente" required type="text" class="input-form font-bold text-slate-900">
                    </div>
                    <div class="md:col-span-1">
                        <label class="label-form">Data Entrada *</label>
                        <input name="data" type="date" value={today} required class="input-form">
                    </div>

                    <div class="md:col-span-2">
                        <label class="label-form">Canal de Origem *</label>
                        <select name="origem" class="input-form font-bold text-slate-700" required>
                            <option value="">SELECIONE...</option>
                            <option value="INSTAGRAM">INSTAGRAM</option>
                            <option value="FORMS INSTAGRAM">FORMS INSTAGRAM</option>
                            <option value="SITE">SITE</option>
                            <option value="WHATSAPP">WHATSAPP</option>
                            <option value="LP META">LP META</option>
                            <option value="LP GOOGLE">LP GOOGLE</option>
                            <option value="INDICA√á√ÉO">INDICA√á√ÉO</option>
                            <option value="RD STATION">RD STATION</option>
                            <option value="E-MAIL MKT">E-MAIL MKT</option>
                            <option value="MIDIA OFF">MIDIA OFF</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label class="label-form text-blue-600">Tipo de Tr√°fego</label>
                        <div class="flex gap-4 mt-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="tipo_trafego" value="ORGANICO" checked class="w-4 h-4 text-slate-900 focus:ring-slate-500">
                                <span class="text-sm font-medium text-slate-700">Org√¢nico</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="radio" name="tipo_trafego" value="PAGO" class="w-4 h-4 text-blue-600 focus:ring-blue-500">
                                <span class="text-sm font-bold text-blue-700 bg-blue-50 px-2 py-0.5 rounded border border-blue-100">Tr√°fego Pago (Ads)</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 border-b border-slate-200">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label class="label-form flex justify-between">
                            <span>Telefone</span>
                            <span class="text-[9px] text-slate-400 font-normal normal-case">Pode colar do Wpp</span>
                        </label>
                        <input name="numero" id="input_telefone" type="text" class="input-form font-mono" placeholder="(11) 99999-9999">
                    </div>
                    
                    <div>
                        <label class="label-form">Segmento</label>
                        <input name="seguimento" type="text" list="list-seg" class="input-form" placeholder="Selecione...">
                        <datalist id="list-seg">
                            <option value="Pote"></option>
                            <option value="Copo"></option>
                            <option value="Pizza"></option>
                            <option value="Cx de Sorvete"></option>
                            <option value="Projeto Especial"></option>
                            <option value="Outros/ N√£o produzimos"></option>
                        </datalist>
                    </div>
                    
                    <div class="md:col-span-2">
                        <label class="label-form">Produto</label>
                        <input name="produto" type="text" list="list-prod" class="input-form" placeholder="Busque o produto...">
                        <datalist id="list-prod">
                            <option value="Projeto Especial"/>
                            <option value="Copo 100ml"/><option value="Copo 200ml"/><option value="Copo 400ml"/><option value="Copo 500ml"/>
                            <option value="Pote 100ml"/><option value="Pote 120ml"/><option value="Pote 150ml"/><option value="Pote 180ml"/>
                            <option value="Pote 240ml"/><option value="Pote 360ml"/><option value="Pote 480ml"/><option value="Pote 500ml"/><option value="Pote 1000ml"/>
                            <option value="Pizza Oitavada"/><option value="Pizza Quadrada"/><option value="Pizza Sextavada"/>
                            <option value="Caixa de Sorvete 5L"/><option value="Caixa de Sorvete 7L"/><option value="Caixa de Sorvete 10L"/>
                        </datalist>
                    </div>

                    <div>
                        <label class="label-form">Qtd. Estimada</label>
                        <select name="quantidade" class="input-form">
                            <option value="">Selecione...</option>
                            <option value="M√≠nimo">M√≠nimo</option>
                            <option value="5 mil">5 mil</option>
                            <option value="10 mil">10 mil</option>
                            <option value="15 mil">15 mil</option>
                            <option value="30 mil">30 mil</option>
                            <option value="50 mil">50 mil</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="p-6 border-b border-slate-200 bg-slate-50/50">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                    <div>
                        <label class="label-form">Qualificado?</label>
                        <select name="qualificado" class="input-form">
                            <option value="">Selecione...</option>
                            <option>N√ÉO</option>
                            <option>SIM</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-form">Delegado Para</label>
                        <select name="delegado" class="input-form">
                            <option value="">-- Selecione --</option>
                            <option value="Clodoaldo">Clodoaldo</option>
                            <option value="Michele">Michele</option>
                            <option value="Angela">Angela</option>
                            <option value="Joelma">Joelma</option>
                            <option value="Ana Julia">Ana Julia</option>
                            <option value="Leonardo">Leonardo</option>
                            <option value="Diretoria">Diretoria</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-form">Status no Chat</label>
                        <select name="status_guru" class="input-form">
                            <option>PRIMEIRO CONTATO</option>
                            <option>EM NEGOCIA√á√ÉO</option>
                            <option>AGUARDANDO RETORNO</option>
                            <option>PERDIDO</option>
                            <option>VENDA FECHADA</option>
                        </select>
                    </div>
                    <div>
                        <label class="label-form">Motivo (se N√£o/Perdido)</label>
                        <input name="motivo" type="text" class="input-form" placeholder="Ex: Pre√ßo, Frete...">
                    </div>
                </div>
            </div>

            <div class="p-6 bg-slate-100">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-center">
                    
                    <div class="md:col-span-3 flex flex-col gap-3">
                        <label class="flex items-center gap-3 p-3 bg-white border border-slate-200 rounded cursor-pointer hover:border-slate-400 transition">
                            <input type="checkbox" name="rd_check" class="w-4 h-4 text-slate-800 rounded focus:ring-slate-500">
                            <span class="text-sm font-medium text-slate-700">Lead no RD Station</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 bg-white border border-slate-200 rounded cursor-pointer hover:border-slate-400 transition">
                            <input type="checkbox" name="pipefy_check" class="w-4 h-4 text-slate-800 rounded focus:ring-slate-500">
                            <span class="text-sm font-medium text-slate-700">Add no Pipefy</span>
                        </label>
                    </div>

                    <div class="md:col-span-9 grid grid-cols-3 gap-6 pl-0 md:pl-6 border-l border-slate-200">
                        <div>
                            <label class="label-form text-slate-700">Venda Fechada?</label>
                            <select name="venda" id="select_venda" class="input-form font-medium" onchange="toggleDate()">
                                <option value="">Em aberto</option>
                                <option value="Sim">Sim (Venda Realizada)</option>
                                <option value="N√£o">N√£o (Perdido)</option>
                            </select>
                        </div>
                        <div>
                            <label class="label-form text-slate-700">Valor do Pedido (R$)</label>
                            <input name="valor" type="text" class="input-form font-mono text-right font-bold text-slate-800" placeholder="0,00">
                        </div>
                        <div id="div_data_venda" class="opacity-50 pointer-events-none">
                            <label class="label-form text-emerald-700">Data do Fechamento</label>
                            <input type="date" name="data_venda" id="input_data_venda" class="input-form border-emerald-300 bg-emerald-50">
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-6 py-4 bg-white border-t border-slate-200 flex justify-end">
                <button type="submit" class="bg-slate-900 text-white px-8 py-3 rounded font-bold text-sm hover:bg-slate-800 transition shadow-sm flex items-center gap-2">
                    <span>‚ûï</span> REGISTRAR LEAD
                </button>
            </div>
        </form>
    </div>

    <script define:vars={{today}}>
        // M√°scara do Telefone Totalmente Blindada
        const inputTelefone = document.getElementById('input_telefone');
        if (inputTelefone) {
            inputTelefone.addEventListener('input', function (e) {
                let raw = e.target.value.replace(/\D/g, '');
                
                // Se colar com 55 (DDI) na frente
                if (raw.startsWith('55') && raw.length >= 12) {
                    raw = raw.substring(2);
                }
                
                // Se tiver 10 d√≠gitos e for celular (come√ßa com 6 a 9), adiciona o 9 extra no meio
                if (raw.length === 10 && ['6','7','8','9'].includes(raw[2])) {
                    raw = raw.substring(0, 2) + '9' + raw.substring(2);
                }

                // Limita a 11 n√∫meros no m√°ximo
                raw = raw.substring(0, 11);

                if (raw.length === 0) {
                    e.target.value = '';
                } else if (raw.length <= 2) {
                    e.target.value = '(' + raw;
                } else if (raw.length <= 6) {
                    e.target.value = '(' + raw.substring(0,2) + ') ' + raw.substring(2);
                } else if (raw.length <= 10) {
                    // Formato Fixo: (XX) XXXX-XXXX
                    e.target.value = '(' + raw.substring(0,2) + ') ' + raw.substring(2,6) + '-' + raw.substring(6);
                } else {
                    // Formato Celular: (XX) 9XXXX-XXXX
                    e.target.value = '(' + raw.substring(0,2) + ') ' + raw.substring(2,7) + '-' + raw.substring(7);
                }
            });
        }

        // L√≥gica da Data de Venda
        function toggleDate() {
            const select = document.getElementById('select_venda');
            const div = document.getElementById('div_data_venda');
            const input = document.getElementById('input_data_venda');

            if (select.value === 'Sim') {
                div.classList.remove('opacity-50', 'pointer-events-none');
                if (!input.value) input.value = today;
            } else {
                div.classList.add('opacity-50', 'pointer-events-none');
            }
        }
    </script>

    <style>
        .label-form { @apply block text-xs font-bold text-slate-500 uppercase mb-1.5 tracking-wide; }
        .input-form { @apply w-full border border-slate-300 rounded px-3 py-2 text-sm text-slate-700 focus:ring-2 focus:ring-slate-500 focus:border-slate-500 outline-none transition bg-white; }
    </style>
</Layout>
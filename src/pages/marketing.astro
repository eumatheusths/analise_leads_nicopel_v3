---
import Layout from '../layouts/Layout.astro';
import { getAuthSheets, SPREADSHEET_ID } from '../lib/sheets';

// Captura a aba (Plataforma) e o Período da URL
const urlPlataforma = Astro.url.searchParams.get('plataforma') || 'todas';
const urlPeriodo = Astro.url.searchParams.get('periodo') || 'mes';

let rawData = [];
let errorMsg = null;

try {
    const sheets = await getAuthSheets();
    
    // Agora lemos até a coluna I, pois a Coluna A passou a ser a DATA
    const response = await sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: `'Trafego_Geral'!A2:I10000`, 
    });
    
    const rows = response.data.values || [];
    
    rawData = rows.map(row => {
        const cleanMoney = (val) => parseFloat(String(val || '0').replace(/[R$\s]/g, '').replace(/\./g, '').replace(',', '.')) || 0;
        const cleanNumber = (val) => parseInt(String(val || '0').replace(/\D/g, '')) || 0;

        return {
            dataStr: row[0] || '', // Nova Coluna A (Data)
            plataforma: row[1] || 'Desconhecida',
            campanha: row[2] || 'Campanha Desconhecida',
            conjunto: row[3] || 'Conjunto Desconhecido',
            anuncio: row[4] || 'Anúncio Desconhecido',
            gasto: cleanMoney(row[5]),
            impressoes: cleanNumber(row[6]),
            cliques: cleanNumber(row[7]),
            resultados: cleanNumber(row[8])
        };
    });

} catch (e) {
    errorMsg = "Erro ao carregar os dados de tráfego: " + e.message;
}

// FUNÇÃO PARA LIDAR COM DATAS
const parseSheetDate = (dStr) => {
    if(dStr.includes('/')) {
        const p = dStr.split('/');
        return new Date(parseInt(p[2]), parseInt(p[1])-1, parseInt(p[0]));
    }
    if(dStr.includes('-')) {
        const p = dStr.split('-');
        if(p[0].length === 4) return new Date(parseInt(p[0]), parseInt(p[1])-1, parseInt(p[2]));
        return new Date(parseInt(p[2]), parseInt(p[1])-1, parseInt(p[0]));
    }
    return new Date(dStr);
};

// FILTRO DUPLO: Plataforma + Período
const filteredData = rawData.filter(row => {
    // 1. Filtro Plataforma
    const platMatch = urlPlataforma === 'todas' || row.plataforma.toLowerCase() === urlPlataforma.toLowerCase();
    
    // 2. Filtro Data
    let dateMatch = true;
    if (urlPeriodo !== 'todos' && row.dataStr) {
        const rowDate = parseSheetDate(row.dataStr);
        const today = new Date();
        today.setHours(0,0,0,0);

        if (urlPeriodo === 'hoje') {
            dateMatch = rowDate.getTime() === today.getTime();
        } else if (urlPeriodo === 'ontem') {
            const ontem = new Date(today);
            ontem.setDate(ontem.getDate() - 1);
            dateMatch = rowDate.getTime() === ontem.getTime();
        } else if (urlPeriodo === 'semana') { // Últimos 7 dias
            const semana = new Date(today);
            semana.setDate(semana.getDate() - 7);
            dateMatch = rowDate >= semana && rowDate <= today;
        } else if (urlPeriodo === 'mes') { // Mês atual
            dateMatch = rowDate.getMonth() === today.getMonth() && rowDate.getFullYear() === today.getFullYear();
        }
    }

    return platMatch && dateMatch;
});

// LÓGICA DE AGRUPAMENTO
const kpisGerais = { gasto: 0, impressoes: 0, cliques: 0, resultados: 0 };
const campanhasAgrupadas = {};

filteredData.forEach(row => {
    kpisGerais.gasto += row.gasto;
    kpisGerais.impressoes += row.impressoes;
    kpisGerais.cliques += row.cliques;
    kpisGerais.resultados += row.resultados;

    if (!campanhasAgrupadas[row.campanha]) {
        campanhasAgrupadas[row.campanha] = { 
            id: row.campanha.replace(/\W/g, ''), nome: row.campanha, plataforma: row.plataforma,
            gasto: 0, impressoes: 0, cliques: 0, resultados: 0, conjuntos: {} 
        };
    }
    const camp = campanhasAgrupadas[row.campanha];
    camp.gasto += row.gasto; camp.impressoes += row.impressoes; camp.cliques += row.cliques; camp.resultados += row.resultados;

    if (!camp.conjuntos[row.conjunto]) {
        camp.conjuntos[row.conjunto] = { id: row.conjunto.replace(/\W/g, ''), nome: row.conjunto, gasto: 0, impressoes: 0, cliques: 0, resultados: 0, anuncios: [] };
    }
    const conj = camp.conjuntos[row.conjunto];
    conj.gasto += row.gasto; conj.impressoes += row.impressoes; conj.cliques += row.cliques; conj.resultados += row.resultados;

    conj.anuncios.push({ id: row.anuncio.replace(/\W/g, ''), nome: row.anuncio, gasto: row.gasto, impressoes: row.impressoes, cliques: row.cliques, resultados: row.resultados });
});

const formataDinheiro = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
const calculaCPM = (gasto, imp) => imp > 0 ? formataDinheiro((gasto / imp) * 1000) : 'R$ 0,00';
const calculaCustoPorResultado = (gasto, res) => res > 0 ? formataDinheiro(gasto / res) : 'R$ 0,00';

const funilCTR = kpisGerais.impressoes > 0 ? ((kpisGerais.cliques / kpisGerais.impressoes) * 100).toFixed(2) : 0;
const funilConv = kpisGerais.cliques > 0 ? ((kpisGerais.resultados / kpisGerais.cliques) * 100).toFixed(2) : 0;

const viewTitles = { 'todas': 'Visão Geral (Cross-Channel)', 'meta': 'Meta Ads (Facebook/Instagram)', 'google': 'Google Ads (Pesquisa/PMax)' };
---

<Layout title="Tráfego Pago - Nicopel">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-8 border-b border-slate-200/60 pb-6 bg-white/80 backdrop-blur-md sticky top-0 z-30 pt-4 -mx-6 px-6 lg:-mx-8 lg:px-8">
        <div>
            <h2 class="text-3xl font-extrabold text-slate-900 tracking-tight flex items-center gap-2">
                Tráfego Pago
                <span class="text-[10px] font-bold text-blue-600 bg-blue-50 border border-blue-100 px-2 py-0.5 rounded-full uppercase tracking-wider">MKT</span>
            </h2>
            <div class="flex items-center gap-3 text-sm mt-1.5">
                <span class="text-slate-400 font-medium">Visualizando:</span>
                <span class="font-bold text-slate-700">{viewTitles[urlPlataforma]}</span>
            </div>
        </div>
        
        <div class="flex flex-col sm:flex-row gap-3 w-full md:w-auto mt-4 md:mt-0 items-center">
            
            <form method="GET" class="flex gap-2 w-full md:w-auto relative group">
                <input type="hidden" name="plataforma" value={urlPlataforma} />
                <select name="periodo" onchange="this.form.submit()" class="appearance-none bg-white border border-slate-200 text-slate-700 py-2 pl-4 pr-10 rounded-lg shadow-sm text-sm font-bold focus:outline-none focus:ring-2 focus:ring-slate-900 focus:border-transparent cursor-pointer transition hover:border-slate-300 w-full">
                    <option value="hoje" selected={urlPeriodo === 'hoje'}>Hoje</option>
                    <option value="ontem" selected={urlPeriodo === 'ontem'}>Ontem</option>
                    <option value="semana" selected={urlPeriodo === 'semana'}>Últimos 7 dias</option>
                    <option value="mes" selected={urlPeriodo === 'mes'}>Este Mês</option>
                    <option value="todos" selected={urlPeriodo === 'todos'}>Todo o Histórico</option>
                </select>
                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-400">
                    <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" /></svg>
                </div>
            </form>

            <div class="bg-white border border-slate-200 rounded-lg flex p-1 shadow-sm w-full md:w-auto overflow-x-auto">
                <a href={`?plataforma=todas&periodo=${urlPeriodo}`} class={`px-4 py-1.5 rounded-md text-xs font-bold uppercase tracking-wide transition-all whitespace-nowrap ${urlPlataforma === 'todas' ? 'bg-slate-900 text-white shadow-md' : 'text-slate-500 hover:text-slate-900 hover:bg-slate-50'}`}>Visão Geral</a>
                <a href={`?plataforma=meta&periodo=${urlPeriodo}`} class={`px-4 py-1.5 rounded-md text-xs font-bold uppercase tracking-wide transition-all flex items-center gap-1.5 whitespace-nowrap ${urlPlataforma === 'meta' ? 'bg-blue-600 text-white shadow-md' : 'text-slate-500 hover:text-blue-600 hover:bg-blue-50'}`}>
                    <span class="w-2 h-2 rounded-full bg-current opacity-80"></span> Meta
                </a>
                <a href={`?plataforma=google&periodo=${urlPeriodo}`} class={`px-4 py-1.5 rounded-md text-xs font-bold uppercase tracking-wide transition-all flex items-center gap-1.5 whitespace-nowrap ${urlPlataforma === 'google' ? 'bg-emerald-600 text-white shadow-md' : 'text-slate-500 hover:text-emerald-600 hover:bg-emerald-50'}`}>
                    <span class="w-2 h-2 rounded-full bg-current opacity-80"></span> Google
                </a>
            </div>
        </div>
    </div>

    {errorMsg && <div class="bg-red-50 text-red-700 p-4 rounded-xl border border-red-200 mb-6 text-sm font-medium shadow-sm">⚠️ {errorMsg}</div>}
    
    {!errorMsg && rawData.length === 0 && (
        <div class="bg-blue-50 text-blue-700 p-4 rounded-xl border border-blue-200 mb-6 text-sm font-medium shadow-sm">
            ℹ️ A aguardar dados. Certifica-te de que o SyncWith já executou e preencheu a aba "Trafego_Geral".
        </div>
    )}

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 auto-rows-min mb-12">
        <div class="bg-white border-l-4 border-emerald-600 border border-slate-200 rounded-xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07)] p-6 flex flex-col justify-between">
            <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Investimento Total</p></div>
            <div class="mt-2">
                <h3 class="text-4xl lg:text-5xl font-bold text-emerald-800 tracking-tighter leading-none">{formataDinheiro(kpisGerais.gasto)}</h3>
                <p class="text-[11px] text-slate-400 mt-2 font-medium">Gasto no período filtrado</p>
            </div>
        </div>

        <div class="bg-white border-l-4 border-blue-600 border border-slate-200 rounded-xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07)] p-6 flex flex-col justify-between">
            <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Resultados</p></div>
            <div class="mt-2">
                <h3 class="text-4xl lg:text-5xl font-bold text-blue-700 tracking-tighter leading-none">{kpisGerais.resultados.toLocaleString('pt-BR')}</h3>
                <p class="text-[11px] text-slate-400 mt-2 font-medium">{calculaCustoPorResultado(kpisGerais.gasto, kpisGerais.resultados)} Custo p/ Resultado</p>
            </div>
        </div>

        <div class="bg-white border-l-4 border-purple-600 border border-slate-200 rounded-xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07)] p-6 flex flex-col justify-between">
            <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Cliques no Link</p></div>
            <div class="mt-2">
                <h3 class="text-4xl lg:text-5xl font-bold text-purple-800 tracking-tighter leading-none">{kpisGerais.cliques.toLocaleString('pt-BR')}</h3>
                <p class="text-[11px] text-slate-400 mt-2 font-medium">CTR: {funilCTR}%</p>
            </div>
        </div>

        <div class="bg-white border-l-4 border-orange-500 border border-slate-200 rounded-xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07)] p-6 flex flex-col justify-between">
            <div><p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">CPM Médio</p></div>
            <div class="mt-2">
                <h3 class="text-4xl lg:text-5xl font-bold text-orange-700 tracking-tighter leading-none">{calculaCPM(kpisGerais.gasto, kpisGerais.impressoes)}</h3>
                <p class="text-[11px] text-slate-400 mt-2 font-medium">{kpisGerais.impressoes.toLocaleString('pt-BR')} Impressões totais</p>
            </div>
        </div>
    </div>

    <div class="bg-white border border-slate-200 rounded-xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07)] overflow-hidden mb-12">
        <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center">
            <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wide flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-blue-500"></span> Funil de Tráfego
            </h3>
        </div>
        
        <div class="p-8 flex flex-col items-center bg-slate-50/50">
            <div class="w-full max-w-2xl flex flex-col items-center gap-1">
                <div class="w-full bg-slate-800 text-white py-4 rounded-t-xl rounded-b-md shadow flex flex-col items-center relative z-30 hover:scale-[1.02] transition-transform">
                    <span class="text-[10px] font-bold text-slate-300 uppercase tracking-widest mb-1">Impressões</span>
                    <span class="text-3xl font-extrabold">{kpisGerais.impressoes.toLocaleString('pt-BR')}</span>
                    <span class="text-[10px] text-slate-400 mt-1">Topo de Funil</span>
                </div>
                
                <div class="flex flex-col items-center my-1.5 z-20">
                    <span class="text-[10px] text-slate-600 font-bold bg-white px-3 py-1 rounded-full border border-slate-200 shadow-sm">↓ {funilCTR}% Conversão</span>
                </div>

                <div class="w-[80%] bg-blue-600 text-white py-4 rounded-md shadow flex flex-col items-center relative z-10 hover:scale-[1.02] transition-transform">
                    <span class="text-[10px] font-bold text-blue-200 uppercase tracking-widest mb-1">Cliques no Link</span>
                    <span class="text-3xl font-extrabold">{kpisGerais.cliques.toLocaleString('pt-BR')}</span>
                    <span class="text-[10px] text-blue-200 mt-1">{calculaCustoPorResultado(kpisGerais.gasto, kpisGerais.cliques)} Custo por Clique (CPC)</span>
                </div>

                <div class="flex flex-col items-center my-1.5 z-0">
                    <span class="text-[10px] text-slate-600 font-bold bg-white px-3 py-1 rounded-full border border-slate-200 shadow-sm">↓ {funilConv}% Conversão</span>
                </div>

                <div class="w-[60%] bg-emerald-600 text-white py-4 rounded-t-md rounded-b-xl shadow flex flex-col items-center hover:scale-[1.02] transition-transform">
                    <span class="text-[10px] font-bold text-emerald-200 uppercase tracking-widest mb-1">Resultados</span>
                    <span class="text-3xl font-extrabold">{kpisGerais.resultados.toLocaleString('pt-BR')}</span>
                    <span class="text-[10px] text-emerald-200 mt-1">{calculaCustoPorResultado(kpisGerais.gasto, kpisGerais.resultados)} Custo por Res. (CPR)</span>
                </div>
            </div>
        </div>
    </div>

    <div class="bg-white border border-slate-200 rounded-xl shadow-[0_2px_15px_-3px_rgba(0,0,0,0.07)] overflow-hidden mb-12">
        <div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center">
            <h3 class="text-sm font-bold text-slate-800 uppercase tracking-wide flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-purple-500"></span> Detalhamento de Campanhas
            </h3>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-xs text-left whitespace-nowrap">
                <thead class="bg-slate-50/50 text-slate-500 font-bold border-b border-slate-200 text-[10px] uppercase tracking-wider">
                    <tr>
                        <th class="px-6 py-4">Campanha / Anúncio</th>
                        <th class="px-6 py-4 text-right">Gasto</th>
                        <th class="px-6 py-4 text-right">CPM</th>
                        <th class="px-6 py-4 text-center">Resultados</th>
                        <th class="px-6 py-4 text-right">Custo por Res.</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-slate-100 bg-white">
                    {Object.values(campanhasAgrupadas).length === 0 && !errorMsg ? (
                        <tr><td colspan="5" class="p-8 text-center text-slate-400 italic">Nenhum dado encontrado para este filtro de data/plataforma.</td></tr>
                    ) : (
                        Object.values(campanhasAgrupadas).map(camp => (
                            <>
                                <tr class="hover:bg-slate-50 transition-colors cursor-pointer group" onclick={`toggleRow('child-camp-${camp.id}', this)`}>
                                    <td class="px-6 py-3.5 font-bold text-slate-800 flex items-center gap-3">
                                        <span class="text-slate-400 transition-transform duration-200 transform arrow-icon group-hover:text-blue-600">▶</span>
                                        {urlPlataforma === 'todas' && (
                                            <span class={`text-[9px] px-1.5 py-0.5 rounded text-white ${camp.plataforma === 'Meta' ? 'bg-blue-600' : 'bg-emerald-600'}`}>
                                                {camp.plataforma}
                                            </span>
                                        )}
                                        {camp.nome}
                                    </td>
                                    <td class="px-6 py-3.5 text-slate-600 font-mono text-right">{formataDinheiro(camp.gasto)}</td>
                                    <td class="px-6 py-3.5 text-slate-500 font-mono text-right">{calculaCPM(camp.gasto, camp.impressoes)}</td>
                                    <td class="px-6 py-3.5 text-blue-700 font-bold text-center bg-blue-50/30">{camp.resultados}</td>
                                    <td class="px-6 py-3.5 text-slate-600 font-mono text-right">{calculaCustoPorResultado(camp.gasto, camp.resultados)}</td>
                                </tr>

                                {Object.values(camp.conjuntos).map(conj => (
                                    <>
                                        <tr class={`hidden child-camp-${camp.id} bg-slate-50/30 hover:bg-slate-100/50 transition cursor-pointer border-l-2 border-transparent hover:border-blue-500`} onclick={`toggleRow('child-conj-${conj.id}', this)`}>
                                            <td class="px-6 py-3 pl-12 text-slate-600 font-medium flex items-center gap-2">
                                                <span class="text-slate-400 transition-transform duration-200 transform arrow-icon text-[10px]">▶</span>
                                                <span class="text-slate-400">↳</span> {conj.nome}
                                            </td>
                                            <td class="px-6 py-3 text-slate-500 font-mono text-right">{formataDinheiro(conj.gasto)}</td>
                                            <td class="px-6 py-3 text-slate-400 font-mono text-right">{calculaCPM(conj.gasto, conj.impressoes)}</td>
                                            <td class="px-6 py-3 text-slate-700 font-bold text-center">{conj.resultados}</td>
                                            <td class="px-6 py-3 text-slate-500 font-mono text-right">{calculaCustoPorResultado(conj.gasto, conj.resultados)}</td>
                                        </tr>

                                        {conj.anuncios.map(ad => (
                                            <tr class={`hidden child-conj-${conj.id} child-camp-${camp.id} bg-slate-100/50 hover:bg-slate-200/50 transition border-l-2 border-transparent hover:border-emerald-500`}>
                                                <td class="px-6 py-2.5 pl-20 text-slate-500 flex items-center gap-2 text-[11px]">
                                                    <span class="text-slate-400">▪</span> {ad.nome}
                                                </td>
                                                <td class="px-6 py-2.5 text-slate-500 font-mono text-right text-[11px]">{formataDinheiro(ad.gasto)}</td>
                                                <td class="px-6 py-2.5 text-slate-400 font-mono text-right text-[11px]">{calculaCPM(ad.gasto, ad.impressoes)}</td>
                                                <td class="px-6 py-2.5 text-slate-600 text-center text-[11px]">{ad.resultados}</td>
                                                <td class="px-6 py-2.5 text-slate-500 font-mono text-right text-[11px]">{calculaCustoPorResultado(ad.gasto, ad.resultados)}</td>
                                            </tr>
                                        ))}
                                    </>
                                ))}
                            </>
                        ))
                    )}
                    
                    {Object.values(campanhasAgrupadas).length > 0 && (
                        <tr class="bg-slate-50 font-bold border-t border-slate-200">
                            <td class="px-6 py-4 text-slate-800 uppercase text-[10px] tracking-wider">Total Final</td>
                            <td class="px-6 py-4 text-emerald-700 font-mono text-right">{formataDinheiro(kpisGerais.gasto)}</td>
                            <td class="px-6 py-4 text-slate-600 font-mono text-right">{calculaCPM(kpisGerais.gasto, kpisGerais.impressoes)}</td>
                            <td class="px-6 py-4 text-blue-700 text-lg text-center">{kpisGerais.resultados}</td>
                            <td class="px-6 py-4 text-slate-700 font-mono text-right">{calculaCustoPorResultado(kpisGerais.gasto, kpisGerais.resultados)}</td>
                        </tr>
                    )}
                </tbody>
            </table>
        </div>
    </div>

    <script is:inline>
        function toggleRow(targetClass, element) {
            const children = document.querySelectorAll('.' + targetClass);
            let isExpanding = false;

            children.forEach(child => {
                if (child.classList.contains('hidden')) {
                    child.classList.remove('hidden');
                    isExpanding = true;
                } else {
                    child.classList.add('hidden');
                    if (targetClass.includes('camp')) {
                        const allNested = document.querySelectorAll('.child-' + targetClass);
                        allNested.forEach(n => n.classList.add('hidden'));
                        child.querySelectorAll('.arrow-icon').forEach(icon => icon.classList.remove('rotate-90'));
                    }
                }
            });

            const arrow = element.querySelector('.arrow-icon');
            if (arrow) {
                if (isExpanding) {
                    arrow.classList.add('rotate-90', 'text-blue-600');
                } else {
                    arrow.classList.remove('rotate-90', 'text-blue-600');
                }
            }
        }
    </script>
</Layout>